name: CI/CD FOR ORDER APP

on:
  push:
    branches:
      - main  # Change this if you have a different default branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ›‘ Step 1: Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ğŸ›‘ Step 2: Set up Python (For Django migrations & collectstatic)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'  # Adjust according to your project

      # ğŸ›‘ Step 3: Install Dependencies (Adjust paths if needed)
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt  # Adjust if requirements are inside folders

      # ğŸ›‘ Step 4: Load Kubeconfig (Required for Kubernetes Deployment)
      - name: Configure Kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      # ğŸ›‘ Step 5: Log in to Docker Hub (Optional: Needed only if pushing images)
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.TanviiSahuu }}  # ğŸ‘‰ Insert in GitHub Secrets
          password: ${{ secrets.docker@2025 }}  # ğŸ‘‰ Insert in GitHub Secrets

      # ğŸ›‘ Step 6: Build & Push Docker Images for Microservices
      - name: Build & Push Docker Images
        run: |
          docker build -t <TanviiSahuu>/petopia_order:latest ./petopia_order
          
          docker push <TanviiSahuu>/petopia_order:latest

      # ğŸ›‘ Step 7: Apply Kubernetes Manifests
      - name: Deploy to Minikube
        run: |
          kubectl apply -f petopia_order/k8s/o-deployment.yaml
          kubectl apply -f petopia_order/k8s/o-service.yaml
          
          kubectl apply -f k8s/ingress.yaml  # Apply Ingress if applicable

      # ğŸ›‘ Step 8: Verify Deployment
      - name: Verify Deployment
        run: |
          kubectl get pods -n default
          kubectl get services -n default
